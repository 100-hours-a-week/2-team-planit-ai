# VectorDB

## π“ κ°μ”

μ΄ ν΄λ”λ” **POI(Point of Interest) λ°μ΄ν„°λ¥Ό λ²΅ν„° μ„λ² λ”©μΌλ΅ μ €μ¥ν•κ³  μ μ‚¬λ„ κΈ°λ° κ²€μƒ‰μ„ μν–‰**ν•λ” μ—μ΄μ „νΈλ“¤μ„ ν¬ν•¨ν•©λ‹λ‹¤. Two-tower μ•„ν‚¤ν…μ²μ POI Tower μ—­ν• μ„ λ‹΄λ‹Ήν•λ©°, ChromaDBλ¥Ό κΈ°λ°μΌλ΅ λ²΅ν„° μ €μ¥ λ° κ²€μƒ‰ κΈ°λ¥μ„ μ κ³µν•©λ‹λ‹¤.

---

## π“„ νμΌ λ©λ΅

### `BaseVectorSearchAgent.py`

#### π“ νμΌ μ„¤λ…

λ²΅ν„° κ²€μƒ‰ μ—μ΄μ „νΈμ **μ¶”μƒ κΈ°λ³Έ ν΄λμ¤(Abstract Base Class)**λ¥Ό μ •μν•©λ‹λ‹¤. λ¨λ“  λ²΅ν„° κ²€μƒ‰ μ—μ΄μ „νΈλ” μ΄ ν΄λμ¤λ¥Ό μƒμ†λ°›μ•„ κµ¬ν„ν•΄μ•Ό ν•©λ‹λ‹¤. Two-tower μ•„ν‚¤ν…μ²μ—μ„ POI Towerμ μΈν„°νμ΄μ¤ μ—­ν• μ„ ν•©λ‹λ‹¤.

---

#### π—οΈ ν΄λμ¤: `BaseVectorSearchAgent`

**μ„¤λ…**: λ²΅ν„° κ²€μƒ‰ μ—μ΄μ „νΈμ μ¶”μƒ κΈ°λ³Έ ν΄λμ¤μ…λ‹λ‹¤. `ABC`λ¥Ό μƒμ†λ°›μ•„ κµ¬ν„λμ—μΌλ©°, ν•μ„ ν΄λμ¤μ—μ„ λ°λ“μ‹ κµ¬ν„ν•΄μ•Ό ν•λ” λ©”μ„λ“λ“¤μ„ μ •μν•©λ‹λ‹¤.

##### π“ ν•„λ“ (Attributes)

> μ΄ ν΄λμ¤λ” μ¶”μƒ ν΄λμ¤λ΅, μΈμ¤ν„΄μ¤ ν•„λ“λ¥Ό μ •μν•μ§€ μ•μµλ‹λ‹¤.

##### π”§ λ©”μ„λ“ (Methods)

**`search(query_embedding: List[float], k: int = 10) -> List[PoiSearchResult]`** *(μ¶”μƒ λ©”μ„λ“)*

- **μ„¤λ…**: μΏΌλ¦¬ μ„λ² λ”© λ²΅ν„°λ¥Ό μ‚¬μ©ν•μ—¬ λ²΅ν„° μ μ‚¬λ„ κ²€μƒ‰μ„ μν–‰ν•©λ‹λ‹¤.
- **νλΌλ―Έν„°**:
  - `query_embedding` (`List[float]`): κ²€μƒ‰μ— μ‚¬μ©ν•  μΏΌλ¦¬ μ„λ² λ”© λ²΅ν„°
  - `k` (`int`, κΈ°λ³Έκ°’: `10`): λ°ν™ν•  κ²€μƒ‰ κ²°κ³Ό μ
- **λ°ν™κ°’**: `List[PoiSearchResult]` - μ μ‚¬λ„κ°€ λ†’μ€ POI κ²€μƒ‰ κ²°κ³Ό λ¦¬μ¤νΈ

---

**`search_by_text(query: str, k: int = 10) -> List[PoiSearchResult]`** *(μ¶”μƒ λ©”μ„λ“)*

- **μ„¤λ…**: ν…μ¤νΈ μΏΌλ¦¬λ΅ κ²€μƒ‰μ„ μν–‰ν•©λ‹λ‹¤. λ‚΄λ¶€μ μΌλ΅ ν…μ¤νΈλ¥Ό μ„λ² λ”©μΌλ΅ λ³€ν™ν•μ—¬ κ²€μƒ‰ν•©λ‹λ‹¤.
- **νλΌλ―Έν„°**:
  - `query` (`str`): κ²€μƒ‰ν•  ν…μ¤νΈ μΏΌλ¦¬
  - `k` (`int`, κΈ°λ³Έκ°’: `10`): λ°ν™ν•  κ²€μƒ‰ κ²°κ³Ό μ
- **λ°ν™κ°’**: `List[PoiSearchResult]` - μ μ‚¬λ„κ°€ λ†’μ€ POI κ²€μƒ‰ κ²°κ³Ό λ¦¬μ¤νΈ

---

**`add_poi(poi: PoiData) -> bool`** *(μ¶”μƒ λ©”μ„λ“)*

- **μ„¤λ…**: λ‹¨μΌ POI λ°μ΄ν„°λ¥Ό λ²΅ν„° DBμ— μ¶”κ°€ν•©λ‹λ‹¤.
- **νλΌλ―Έν„°**:
  - `poi` (`PoiData`): μ¶”κ°€ν•  POI λ°μ΄ν„° κ°μ²΄
- **λ°ν™κ°’**: `bool` - μ¶”κ°€ μ„±κ³µ μ—¬λ¶€

---

**`add_pois_batch(pois: List[PoiData]) -> int`** *(μ¶”μƒ λ©”μ„λ“)*

- **μ„¤λ…**: μ—¬λ¬ POI λ°μ΄ν„°λ¥Ό λ°°μΉλ΅ λ²΅ν„° DBμ— μ¶”κ°€ν•©λ‹λ‹¤.
- **νλΌλ―Έν„°**:
  - `pois` (`List[PoiData]`): μ¶”κ°€ν•  POI λ°μ΄ν„° λ¦¬μ¤νΈ
- **λ°ν™κ°’**: `int` - μ„±κ³µμ μΌλ΅ μ¶”κ°€λ POI κ°μ

---

**`get_collection_size() -> int`** *(μ¶”μƒ λ©”μ„λ“)*

- **μ„¤λ…**: λ²΅ν„° DBμ— μ €μ¥λ ν„μ¬ λ°μ΄ν„° κ°μλ¥Ό λ°ν™ν•©λ‹λ‹¤.
- **νλΌλ―Έν„°**: μ—†μ
- **λ°ν™κ°’**: `int` - μ €μ¥λ λ°μ΄ν„° κ°μ

---

### `VectorSearchAgent.py`

#### π“ νμΌ μ„¤λ…

`BaseVectorSearchAgent`λ¥Ό μƒμ†λ°›μ•„ **ChromaDB κΈ°λ°μ λ²΅ν„° κ²€μƒ‰ κΈ°λ¥μ„ κµ¬ν„**ν• ν΄λμ¤μ…λ‹λ‹¤. POI μ„λ² λ”©μ„ μ €μ¥ν•κ³  κ²€μƒ‰ν•λ©°, DBκ°€ λΉ„μ–΄μμ–΄λ„ μ—λ¬ μ—†μ΄ λΉ κ²°κ³Όλ¥Ό λ°ν™ν•λ„λ΅ μ„¤κ³„λμ—μµλ‹λ‹¤. μ§€μ—° λ΅λ”©(Lazy Loading) ν¨ν„΄μ„ μ‚¬μ©ν•μ—¬ ν•„μ”ν•  λ•λ§ ChromaDBλ¥Ό μ΄κΈ°ν™”ν•©λ‹λ‹¤.

---

#### π—οΈ ν΄λμ¤: `VectorSearchAgent`

**μ„¤λ…**: ChromaDBλ¥Ό μ‚¬μ©ν•μ—¬ POI μ„λ² λ”©μ„ μ €μ¥ν•κ³  μ½”μ‚¬μΈ μ μ‚¬λ„ κΈ°λ° κ²€μƒ‰μ„ μν–‰ν•λ” μ—μ΄μ „νΈμ…λ‹λ‹¤. `BaseVectorSearchAgent`λ¥Ό μƒμ†λ°›μ•„ κµ¬ν„λμ—μµλ‹λ‹¤.

##### π“ ν•„λ“ (Attributes)

| ν•„λ“λ… | νƒ€μ… | μ„¤λ… |
|--------|------|------|
| `collection_name` | `str` | ChromaDB μ»¬λ ‰μ… μ΄λ¦„ (κΈ°λ³Έκ°’: `"poi_embeddings"`) |
| `persist_directory` | `Optional[str]` | λ°μ΄ν„°λ¥Ό μκµ¬ μ €μ¥ν•  λ””λ ‰ν† λ¦¬ κ²½λ΅. `None`μ΄λ©΄ λ©”λ¨λ¦¬μ—λ§ μ €μ¥ |
| `_client` | `chromadb.Client \| None` | ChromaDB ν΄λΌμ΄μ–ΈνΈ μΈμ¤ν„΄μ¤ (λ‚΄λ¶€μ©) |
| `_collection` | `chromadb.Collection \| None` | ChromaDB μ»¬λ ‰μ… μΈμ¤ν„΄μ¤ (λ‚΄λ¶€μ©) |
| `_initialized` | `bool` | μ΄κΈ°ν™” μ™„λ£ μ—¬λ¶€ ν”λκ·Έ (λ‚΄λ¶€μ©) |

##### π”§ λ©”μ„λ“ (Methods)

**`__init__(collection_name: str = "poi_embeddings", persist_directory: Optional[str] = None)`**

- **μ„¤λ…**: VectorSearchAgent μΈμ¤ν„΄μ¤λ¥Ό μƒμ„±ν•©λ‹λ‹¤.
- **νλΌλ―Έν„°**:
  - `collection_name` (`str`, κΈ°λ³Έκ°’: `"poi_embeddings"`): μ‚¬μ©ν•  ChromaDB μ»¬λ ‰μ… μ΄λ¦„
  - `persist_directory` (`Optional[str]`, κΈ°λ³Έκ°’: `None`): λ°μ΄ν„°λ¥Ό μκµ¬ μ €μ¥ν•  λ””λ ‰ν† λ¦¬. `None`μ΄λ©΄ μΈλ©”λ¨λ¦¬ λ¨λ“λ΅ λ™μ‘

---

**`_initialize() -> bool`** *(λ‚΄λ¶€ λ©”μ„λ“)*

- **μ„¤λ…**: ChromaDB ν΄λΌμ΄μ–ΈνΈμ™€ μ»¬λ ‰μ…μ„ μ΄κΈ°ν™”ν•©λ‹λ‹¤. μ§€μ—° λ΅λ”© ν¨ν„΄μ„ μ‚¬μ©ν•μ—¬ μ²« μ‚¬μ© μ‹μ—λ§ μ΄κΈ°ν™”λ©λ‹λ‹¤.
- **νλΌλ―Έν„°**: μ—†μ
- **λ°ν™κ°’**: `bool` - μ΄κΈ°ν™” μ„±κ³µ μ—¬λ¶€
- **λ™μ‘ λ°©μ‹**:
  1. μ΄λ―Έ μ΄κΈ°ν™”λ κ²½μ° `True` λ°ν™
  2. `persist_directory`κ°€ μ„¤μ •λλ©΄ `PersistentClient`, μ•„λ‹λ©΄ `Client` μƒμ„±
  3. `get_or_create_collection`μΌλ΅ μ»¬λ ‰μ… μƒμ„±/νλ“ (μ½”μ‚¬μΈ κ±°λ¦¬ μ‚¬μ©)
- **μμ™Έ μ²λ¦¬**:
  - ChromaDB λ―Έμ„¤μΉ μ‹ `ImportError` μ²λ¦¬
  - κΈ°νƒ€ μ΄κΈ°ν™” μ¤λ¥ μ‹ `False` λ°ν™

---

**`search(query_embedding: List[float], k: int = 10) -> List[PoiSearchResult]`** *(λΉ„λ™κΈ°)*

- **μ„¤λ…**: μ„λ² λ”© λ²΅ν„°λ¥Ό μ‚¬μ©ν•μ—¬ λ²΅ν„° μ μ‚¬λ„ κ²€μƒ‰μ„ μν–‰ν•©λ‹λ‹¤.
- **νλΌλ―Έν„°**:
  - `query_embedding` (`List[float]`): μΏΌλ¦¬ μ„λ² λ”© λ²΅ν„°
  - `k` (`int`, κΈ°λ³Έκ°’: `10`): λ°ν™ν•  κ²°κ³Ό μ
- **λ°ν™κ°’**: `List[PoiSearchResult]` - κ²€μƒ‰ κ²°κ³Ό λ¦¬μ¤νΈ. μ¤λ¥ μ‹ λΉ λ¦¬μ¤νΈ λ°ν™
- **λ™μ‘ λ°©μ‹**:
  1. ChromaDB μ΄κΈ°ν™” ν™•μΈ
  2. `query_embeddings`λ΅ μ μ‚¬λ„ κ²€μƒ‰ μν–‰
  3. μ½”μ‚¬μΈ κ±°λ¦¬λ¥Ό μ μ‚¬λ„ μ μ(1 - distance)λ΅ λ³€ν™
  4. `PoiSearchResult` κ°μ²΄ λ¦¬μ¤νΈ μƒμ„± λ° λ°ν™

---

**`search_by_text(query: str, k: int = 10) -> List[PoiSearchResult]`** *(λΉ„λ™κΈ°)*

- **μ„¤λ…**: ν…μ¤νΈ μΏΌλ¦¬λ΅ κ²€μƒ‰ν•©λ‹λ‹¤. ChromaDB λ‚΄μ¥ μ„λ² λ”© κΈ°λ¥μ„ μ‚¬μ©ν•©λ‹λ‹¤.
- **νλΌλ―Έν„°**:
  - `query` (`str`): κ²€μƒ‰ν•  ν…μ¤νΈ
  - `k` (`int`, κΈ°λ³Έκ°’: `10`): λ°ν™ν•  κ²°κ³Ό μ
- **λ°ν™κ°’**: `List[PoiSearchResult]` - κ²€μƒ‰ κ²°κ³Ό λ¦¬μ¤νΈ. μ»¬λ ‰μ…μ΄ λΉ„μ–΄μκ±°λ‚ μ¤λ¥ μ‹ λΉ λ¦¬μ¤νΈ λ°ν™
- **λ™μ‘ λ°©μ‹**:
  1. ChromaDB μ΄κΈ°ν™” ν™•μΈ
  2. μ»¬λ ‰μ…μ΄ λΉ„μ–΄μμΌλ©΄ λΉ λ¦¬μ¤νΈ λ°ν™
  3. `query_texts`λ΅ ν…μ¤νΈ κΈ°λ° κ²€μƒ‰ μν–‰
  4. κ²°κ³Όλ¥Ό `PoiSearchResult` κ°μ²΄λ΅ λ³€ν™

---

**`add_poi(poi: PoiData) -> bool`** *(λΉ„λ™κΈ°)*

- **μ„¤λ…**: λ‹¨μΌ POI λ°μ΄ν„°λ¥Ό λ²΅ν„° DBμ— μ¶”κ°€ν•©λ‹λ‹¤.
- **νλΌλ―Έν„°**:
  - `poi` (`PoiData`): μ¶”κ°€ν•  POI λ°μ΄ν„°
- **λ°ν™κ°’**: `bool` - μ¶”κ°€ μ„±κ³µ μ—¬λ¶€
- **μ €μ¥λλ” λ©”νƒ€λ°μ΄ν„°**:
  - `name`, `category`, `description`, `address`, `source`, `source_url`

---

**`add_pois_batch(pois: List[PoiData]) -> int`** *(λΉ„λ™κΈ°)*

- **μ„¤λ…**: μ—¬λ¬ POI λ°μ΄ν„°λ¥Ό λ°°μΉλ΅ μ¶”κ°€ν•©λ‹λ‹¤.
- **νλΌλ―Έν„°**:
  - `pois` (`List[PoiData]`): μ¶”κ°€ν•  POI λ°μ΄ν„° λ¦¬μ¤νΈ
- **λ°ν™κ°’**: `int` - μ„±κ³µμ μΌλ΅ μ¶”κ°€λ POI κ°μ. λΉ λ¦¬μ¤νΈλ‚ μ¤λ¥ μ‹ `0` λ°ν™
- **λ™μ‘ λ°©μ‹**:
  1. λ¨λ“  POIμ ID, λ¬Έμ„, λ©”νƒ€λ°μ΄ν„°λ¥Ό λ¦¬μ¤νΈλ΅ μμ§‘
  2. ν• λ²μ `add()` νΈμ¶λ΅ λ°°μΉ μ €μ¥

---

**`get_collection_size() -> int`** *(λΉ„λ™κΈ°)*

- **μ„¤λ…**: λ²΅ν„° DBμ— μ €μ¥λ ν„μ¬ λ°μ΄ν„° κ°μλ¥Ό λ°ν™ν•©λ‹λ‹¤.
- **νλΌλ―Έν„°**: μ—†μ
- **λ°ν™κ°’**: `int` - μ €μ¥λ λ°μ΄ν„° κ°μ. μ΄κΈ°ν™” μ‹¤ν¨ λλ” μ¤λ¥ μ‹ `0` λ°ν™

---

## π”— μμ΅΄μ„±

- `chromadb`: λ²΅ν„° λ°μ΄ν„°λ² μ΄μ¤
- `app.core.models.PoiAgentDataclass.poi`: `PoiSearchResult`, `PoiData`, `PoiSource` λ°μ΄ν„°ν΄λμ¤
